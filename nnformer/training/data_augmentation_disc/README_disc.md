# è…°æ¤é—´ç›˜é€€å˜MRIæ•°æ®å¢å¼ºæ¨¡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¨¡å—ä¸ºè…°æ¤é—´ç›˜é€€å˜MRIå›¾åƒæä¾›ä¸“ç”¨çš„3Dæ•°æ®å¢å¼ºåŠŸèƒ½ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- âœ… **8ç§å¢å¼ºæŠ€æœ¯**ï¼šæ—‹è½¬ã€é•œåƒã€Gammaã€äº®åº¦ã€å¯¹æ¯”åº¦ã€å™ªå£°ã€æ¨¡ç³Šã€ä½åˆ†è¾¨ç‡
- âœ… **ä¿å®ˆå‚æ•°è®¾è®¡**ï¼šä¿æŒè„ŠæŸ±è§£å‰–ç»“æ„çš„æœ‰æ•ˆæ€§
- âœ… **ç©ºé—´ä¸€è‡´æ€§**ï¼šå›¾åƒå’Œæ ‡ç­¾åŒæ­¥å¢å¼º
- âœ… **æ¦‚ç‡çº¿æ€§è¡°å‡**ï¼šå¢å¼ºæ¦‚ç‡éšepochè‡ªåŠ¨é€’å‡
- âœ… **è®­ç»ƒæ—¶åŠ¨æ€åº”ç”¨**ï¼šæ¯ä¸ªepochçœ‹åˆ°ä¸åŒçš„å¢å¼ºç‰ˆæœ¬

## ğŸ¯ è®¾è®¡ç†å¿µ

### ä¸ºä»€ä¹ˆåœ¨è®­ç»ƒæ—¶å¢å¼ºï¼Ÿ

1. **æœ€å¤§åŒ–æ•°æ®å¤šæ ·æ€§**ï¼šæ¯ä¸ªepochéƒ½æ˜¯ä¸åŒçš„å¢å¼ºç‰ˆæœ¬
2. **èŠ‚çœå­˜å‚¨ç©ºé—´**ï¼šä¸éœ€è¦ä¿å­˜å¤šä¸ªå¢å¼ºå‰¯æœ¬
3. **çµæ´»è°ƒæ•´ç­–ç•¥**ï¼šå¯éšæ—¶ä¿®æ”¹å¢å¼ºå‚æ•°
4. **ç¬¦åˆæœ€ä½³å®è·µ**ï¼šåŒ»å­¦å›¾åƒåˆ†æçš„æ ‡å‡†æµç¨‹

### æ¦‚ç‡è¡°å‡ç­–ç•¥

```
æ¦‚ç‡ = initial_p + (final_p - initial_p) * (current_epoch / max_epochs)

é»˜è®¤é…ç½®ï¼š
- initial_p = 0.2  (20% åœ¨epoch 0)
- final_p = 0.05   (5% åœ¨epoch 1000)
- çº¿æ€§é€’å‡
```

**åŸç†**ï¼š
- è®­ç»ƒåˆæœŸï¼šå¼ºå¢å¼ºå¸®åŠ©æ¨¡å‹å¿«é€Ÿå­¦ä¹ å¤šæ ·æ€§
- è®­ç»ƒåæœŸï¼šå¼±å¢å¼ºè®©æ¨¡å‹ç²¾ç»†è°ƒä¼˜

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é¢„å¤„ç†é˜¶æ®µï¼ˆcropping.pyï¼‰

é¢„å¤„ç†åªåšåŸºç¡€æ“ä½œï¼Œ**ä¸åšå¢å¼º**ï¼š
```python
# åœ¨ ImageCropper ä¸­
1. è¯»å–NIfTIæ–‡ä»¶
2. PyTorchä¸‰ç»´æ’å€¼é‡é‡‡æ · â†’ (512, 512, 85)
3. ä¸­å¿ƒè£å‰ª â†’ (85, 256, 216)
4. å¼ºåº¦å½’ä¸€åŒ–
5. ä¿å­˜ä¸º.npzæ–‡ä»¶
```

### 2. è®­ç»ƒé˜¶æ®µï¼ˆnnFormerTrainerV2_nnformer_disc.pyï¼‰

è®­ç»ƒæ—¶åŠ¨æ€åº”ç”¨å¢å¼ºï¼š

```python
# åœ¨ run_iteration æ–¹æ³•ä¸­
1. åŠ è½½.npzæ•°æ®
2. å¯¹æ¯ä¸ªbatchæ ·æœ¬åº”ç”¨å¢å¼ºï¼ˆè‡ªåŠ¨æ ¹æ®epochè°ƒæ•´æ¦‚ç‡ï¼‰
3. é€å…¥ç½‘ç»œè®­ç»ƒ
```

### 3. éªŒè¯/æµ‹è¯•é˜¶æ®µ

**è‡ªåŠ¨ç¦ç”¨å¢å¼º**ï¼š
- `run_iteration` çš„ `do_backprop=False` æ—¶ä¸å¢å¼º
- ç¡®ä¿éªŒè¯å’Œæµ‹è¯•ä½¿ç”¨åŸå§‹æ•°æ®

## ğŸ“Š å¢å¼ºæŠ€æœ¯è¯¦è§£

### 1. éšæœºæ—‹è½¬ (Random 3D Rotation)
```python
rotation_angle_range=(-15, 15)  # Â±15åº¦
```
- éšæœºé€‰æ‹©3Dæ—‹è½¬å¹³é¢ï¼š(Z,X), (Z,Y), (X,Y)
- ä¿å®ˆè§’åº¦èŒƒå›´ï¼Œä¿æŠ¤è„ŠæŸ±ç»“æ„
- å›¾åƒï¼šä¸‰æ¬¡æ ·æ¡æ’å€¼ (order=3)
- æ ‡ç­¾ï¼šæœ€è¿‘é‚»æ’å€¼ (order=0)

### 2. é•œåƒç¿»è½¬ (Mirror Flipping)
```python
mirror_axes=(0, 1, 2)  # Z, X, Yè½´
```
- éšæœºé€‰æ‹©ä¸€ä¸ªè½´è¿›è¡Œç¿»è½¬
- é€‚ç”¨äºè„ŠæŸ±çš„å·¦å³å¯¹ç§°æ€§
- æ³¨æ„ï¼šZè½´ç¿»è½¬ä¼šæ”¹å˜ä¸Šä¸‹æ–¹å‘

### 3. Gammaæ ¡æ­£ (Gamma Correction)
```python
gamma_range=(0.7, 1.5)
```
- éçº¿æ€§å¯¹æ¯”åº¦è°ƒæ•´
- æ¨¡æ‹Ÿä¸åŒçš„MRIé‡‡é›†å‚æ•°
- ä»…ä½œç”¨äºå›¾åƒï¼Œä¸å½±å“æ ‡ç­¾

### 4. äº®åº¦è°ƒæ•´ (Brightness Adjustment)
```python
brightness_range=(-0.2, 0.2)  # ç›¸å¯¹äºæ ‡å‡†å·®
```
- æ·»åŠ /å‡å»å¸¸æ•°ï¼ˆæŒ‰å›¾åƒæ ‡å‡†å·®ç¼©æ”¾ï¼‰
- æ¨¡æ‹Ÿæ‰«æä»ªæ ¡å‡†å·®å¼‚

### 5. å¯¹æ¯”åº¦è°ƒæ•´ (Contrast Adjustment)
```python
contrast_range=(0.75, 1.25)  # ä¹˜æ•°å› å­
```
- å›´ç»•å‡å€¼ç›¸ä¹˜
- å¢å¼º/å‡å¼±ç»„ç»‡å¯¹æ¯”åº¦

### 6. é«˜æ–¯å™ªå£° (Gaussian Noise)
```python
noise_variance=(0, 0.05)  # ç›¸å¯¹äºæ ‡å‡†å·®
```
- æ·»åŠ çœŸå®çš„æ‰«æä»ªå™ªå£°
- æé«˜æ¨¡å‹é²æ£’æ€§

### 7. é«˜æ–¯æ¨¡ç³Š (Gaussian Blur)
```python
blur_sigma=(0.5, 1.5)
```
- æ¨¡æ‹Ÿè½»å¾®çš„è¿åŠ¨æ¨¡ç³Š
- å‡å°‘å¯¹é«˜é¢‘ç»†èŠ‚çš„è¿‡æ‹Ÿåˆ

### 8. ä½åˆ†è¾¨ç‡æ¨¡æ‹Ÿ (Low Resolution Simulation)
```python
low_res_scale=(0.5, 1.0)
```
- ä¸‹é‡‡æ ·å†ä¸Šé‡‡æ ·
- æ¨¡æ‹Ÿä¸åŒåˆ†è¾¨ç‡çš„æ‰«æ
- ä½¿ç”¨PyTorchæ’å€¼ï¼ˆGPUåŠ é€Ÿï¼‰

## âš™ï¸ é…ç½®å‚æ•°

### å½“å‰é»˜è®¤é…ç½®ï¼ˆnnFormerTrainerV2_nnformer_disc.pyï¼‰

```python
self.disc_augmentor = DataAugmentation3D_disc(
    # å¢å¼ºå¼€å…³ï¼ˆå…¨éƒ¨å¯ç”¨ï¼‰
    do_rotation=True,
    do_mirror=True,
    do_gamma=True,
    do_brightness=True,
    do_contrast=True,
    do_noise=True,
    do_blur=True,
    do_low_res=True,
    
    # å¢å¼ºå‚æ•°ï¼ˆé’ˆå¯¹è…°æ¤é—´ç›˜ä¼˜åŒ–ï¼‰
    rotation_angle_range=(-15, 15),
    mirror_axes=(0, 1, 2),
    gamma_range=(0.7, 1.5),
    brightness_range=(-0.2, 0.2),
    contrast_range=(0.75, 1.25),
    noise_variance=(0, 0.05),
    blur_sigma=(0.5, 1.5),
    low_res_scale=(0.5, 1.0),
    
    # æ¦‚ç‡è¡°å‡å‚æ•°
    initial_p=0.2,           # 20%
    final_p=0.05,            # 5%
    max_epochs=1000
)
```

### ä¿®æ”¹é…ç½®

å¦‚éœ€è°ƒæ•´ï¼Œä¿®æ”¹ `nnFormerTrainerV2_nnformer_disc.py` çš„ `__init__` æ–¹æ³•ï¼š

```python
# ä¾‹å¦‚ï¼šæ›´ä¿å®ˆçš„å¢å¼º
self.disc_augmentor = DataAugmentation3D_disc(
    rotation_angle_range=(-10, 10),    # æ›´å°è§’åº¦
    mirror_axes=(1, 2),                 # ä¸ç¿»è½¬Zè½´
    initial_p=0.15,                     # æ›´ä½åˆå§‹æ¦‚ç‡
    final_p=0.02,                       # æ›´ä½æœ€ç»ˆæ¦‚ç‡
    max_epochs=self.max_num_epochs
)

# æˆ–è€…ï¼šç¦ç”¨æŸäº›å¢å¼º
self.disc_augmentor = DataAugmentation3D_disc(
    do_rotation=True,
    do_mirror=True,
    do_gamma=False,        # ç¦ç”¨gamma
    do_brightness=False,   # ç¦ç”¨äº®åº¦
    do_contrast=True,
    do_noise=True,
    do_blur=False,         # ç¦ç”¨æ¨¡ç³Š
    do_low_res=False,      # ç¦ç”¨ä½åˆ†è¾¨ç‡
    ...
)
```

### å®Œå…¨ç¦ç”¨å¢å¼º

åœ¨ `nnFormerTrainerV2_nnformer_disc.py` çš„ `__init__` ä¸­ï¼š
```python
self.use_disc_augmentation = False  # è®¾ä¸ºFalse
```

## ğŸ“ˆ è®­ç»ƒç›‘æ§

### æ—¥å¿—è¾“å‡º

è®­ç»ƒæ—¶ä¼šè‡ªåŠ¨è®°å½•å½“å‰çš„å¢å¼ºæ¦‚ç‡ï¼š
```
Epoch 0:   Disc augmentation probability: 0.2000
Epoch 100: Disc augmentation probability: 0.1700
Epoch 500: Disc augmentation probability: 0.1250
Epoch 999: Disc augmentation probability: 0.0500
```

### å¯è§†åŒ–æ¦‚ç‡è¡°å‡

```python
import matplotlib.pyplot as plt
import numpy as np

# æ¨¡æ‹Ÿ1000ä¸ªepochçš„æ¦‚ç‡å˜åŒ–
epochs = np.arange(1000)
initial_p = 0.2
final_p = 0.05
prob = initial_p + (final_p - initial_p) * (epochs / 1000)

plt.plot(epochs, prob)
plt.xlabel('Epoch')
plt.ylabel('Augmentation Probability')
plt.title('Augmentation Probability Decay')
plt.grid(True)
plt.show()
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµç¨‹

```
è®­ç»ƒæ•°æ®æµ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  .npzæ–‡ä»¶    â”‚ (å·²å½’ä¸€åŒ–)
â”‚ (85,256,216) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataLoader   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ run_iteration()              â”‚
â”‚ for each sample in batch:   â”‚
â”‚   if training:               â”‚
â”‚     åº”ç”¨å¢å¼º(æ ¹æ®epochè°ƒæ•´p) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  to_torch()  â”‚
â”‚  to_cuda()   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Network    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ€§èƒ½è€ƒè™‘

1. **CPU vs GPU**ï¼šå¢å¼ºåœ¨CPUä¸Šæ‰§è¡Œï¼ˆæ•°æ®åŠ è½½é˜¶æ®µï¼‰
2. **é€Ÿåº¦**ï¼šæ—‹è½¬æœ€æ…¢ï¼Œå…¶ä»–å¢å¼ºå¾ˆå¿«
3. **å†…å­˜**ï¼šæŒ‰æ ·æœ¬å¤„ç†ï¼Œä¸ä¼šæ˜¾è‘—å¢åŠ å†…å­˜

### æ¦‚ç‡è®¡ç®—

æ¯ä¸ªå¢å¼ºæŠ€æœ¯ç‹¬ç«‹åˆ¤æ–­æ˜¯å¦åº”ç”¨ï¼š
```python
if np.random.rand() < current_p:
    # åº”ç”¨è¯¥å¢å¼º
```

è¿™æ„å‘³ç€ä¸€ä¸ªæ ·æœ¬å¯èƒ½åŒæ—¶åº”ç”¨å¤šä¸ªå¢å¼ºï¼Œä¹Ÿå¯èƒ½ä¸€ä¸ªéƒ½ä¸åº”ç”¨ã€‚

## âœ… éªŒè¯æ£€æŸ¥

### ç¡®è®¤å¢å¼ºç”Ÿæ•ˆ

1. æŸ¥çœ‹è®­ç»ƒæ—¥å¿—ï¼Œç¡®è®¤æœ‰æ¦‚ç‡è¾“å‡º
2. ç¬¬ä¸€ä¸ªepochåº”è¯¥æ˜¾ç¤º `0.2000`
3. éšepochå¢åŠ ï¼Œæ¦‚ç‡åº”è¯¥çº¿æ€§ä¸‹é™

### ç¡®è®¤ç©ºé—´ä¸€è‡´æ€§

å¢å¼ºå™¨è‡ªåŠ¨ä¿è¯ï¼š
- å›¾åƒå’Œæ ‡ç­¾åŒæ­¥å˜æ¢
- æ ‡ç­¾å€¼ä¿æŒä¸å˜ï¼ˆåªæœ‰ç©ºé—´ä½ç½®å˜åŒ–ï¼‰
- èƒŒæ™¯åŒºåŸŸæ­£ç¡®å¤„ç†

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šå¢å¼ºæœªç”Ÿæ•ˆ
**æ£€æŸ¥**ï¼š
```python
self.use_disc_augmentation = True  # ç¡®è®¤ä¸ºTrue
```

### é—®é¢˜2ï¼šè®­ç»ƒè¿‡æ…¢
**è§£å†³**ï¼š
```python
# ç¦ç”¨æ—‹è½¬å’Œä½åˆ†è¾¨ç‡ï¼ˆæœ€æ…¢çš„ä¸¤ä¸ªï¼‰
do_rotation=False,
do_low_res=False,
```

### é—®é¢˜3ï¼šæ¨¡å‹ä¸æ”¶æ•›
**å¯èƒ½åŸå› **ï¼šå¢å¼ºå¤ªå¼º
**è§£å†³**ï¼š
```python
# é™ä½åˆå§‹æ¦‚ç‡
initial_p=0.1,  # ä»0.2é™åˆ°0.1
```

### é—®é¢˜4ï¼šéªŒè¯é›†ä¹Ÿè¢«å¢å¼ºäº†
**æ£€æŸ¥**ï¼šç¡®è®¤ `run_iteration` ä¸­çš„æ¡ä»¶åˆ¤æ–­
```python
if do_backprop and self.use_disc_augmentation:
```
`do_backprop=False` æ—¶ä¸åº”å¢å¼ºã€‚

## ğŸ“š æ–‡ä»¶ç»“æ„

```
nnformer/
â”œâ”€â”€ preprocessing/
â”‚   â””â”€â”€ cropping.py              # é¢„å¤„ç†ï¼ˆé‡é‡‡æ ·+è£å‰ª+å½’ä¸€åŒ–ï¼‰
â”‚
â””â”€â”€ training/
    â”œâ”€â”€ data_augmentation_disc/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ augmentation_disc.py # å¢å¼ºå®ç°
    â”‚   â””â”€â”€ README_disc.md       # æœ¬æ–‡æ¡£
    â”‚
    â””â”€â”€ network_training/
        â””â”€â”€ nnFormerTrainerV2_nnformer_disc.py  # è®­ç»ƒå™¨ï¼ˆé›†æˆå¢å¼ºï¼‰
```

## ğŸ“ å¼•ç”¨

å¦‚æœä½¿ç”¨æœ¬å¢å¼ºæ¨¡å—ï¼Œè¯·å¼•ç”¨ï¼š
- åŸå§‹nnFormerè®ºæ–‡
- PyTorchå’Œç›¸å…³åº“

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬README
2. æ£€æŸ¥è®­ç»ƒæ—¥å¿—
3. è°ƒæ•´å¢å¼ºå‚æ•°

---

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°**: 2025å¹´10æœˆ  
**é€‚ç”¨**: è…°æ¤é—´ç›˜é€€å˜MRIåˆ†æ

